include:
  - path: app/connector/mypostgres/compose.yaml
services:
  engine:
    build:
      context: engine
      dockerfile: Dockerfile.engine
      pull: true
    environment:
      AUTHN_CONFIG_PATH: /md/auth_config.json
      ENABLE_CORS: "true"
      ENABLE_SQL_INTERFACE: "true"
      INTROSPECTION_METADATA_FILE: /md/metadata.json
      METADATA_PATH: /md/open_dd.json
      OTLP_ENDPOINT: http://jaeger:4317
    extra_hosts:
      - local.hasura.dev:host-gateway
    labels:
      io.hasura.ddn.service-name: engine
    ports:
      - 3280:3000

  plugin:
    # image: ghcr.io/hasura/engine-plugin-restified-endpoint:latest
    build:
      context: ..
    ports:
      - 8787:8787
    environment:
      HASURA_DDN_PLUGIN_CONFIG_PATH: "/config"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"
      GRAPHQL_SERVER_URL: "http://engine:3000/graphql"
      HASURA_M_AUTH: zZkhKqFjqXR4g5MZCsJUZCnhCcoPyZ
      LOG_LEVEL: debug
    volumes:
      - type: bind
        source: ./config/plugin/
        target: /config/
        read_only: true

  jaeger:
    image: jaegertracing/all-in-one:1.56
    restart: always
    ports:
      - 4003:16686
      - 4317:4317
      - 4318:4318
    environment:
      COLLECTOR_OTLP_ENABLED: "true"

  postgres:
    build:
      context: ./build/postgres
    ports:
      - 5432:5432
    environment:
      POSTGRES_PASSWORD: "password"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
